<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nigeria Tax Compliance & Profit Tracker - Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .tab-active {
            border-bottom: 3px solid #059669;
            color: #059669;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-50">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- Data Service (LocalStorage Wrapper) ---
        const DB_KEY = 'nigeria_tax_tracker_v3';

        const DataService = {
            load: () => {
                try {
                    const data = localStorage.getItem(DB_KEY);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error("Load failed", e);
                    return null;
                }
            },
            save: (data) => {
                try {
                    localStorage.setItem(DB_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error("Save failed", e);
                    alert("Quota exceeded! Clear some data.");
                }
            }
        };

        const TaxComplianceTracker = () => {
            // State
            const [businessInfo, setBusinessInfo] = useState({
                name: '',
                rcNumber: '',
                tin: '',
                fiscalYearStart: new Date().getFullYear() + '-01-01'
            });

            const [salesEntries, setSalesEntries] = useState([]);
            const [expenseEntries, setExpenseEntries] = useState([]);
            const [activeTab, setActiveTab] = useState('entry'); // 'entry' | 'summary'
            const [viewPeriod, setViewPeriod] = useState('monthly'); // 'weekly', 'monthly', 'yearly'

            // --- Persistence Effects ---

            // Load on Mount
            useEffect(() => {
                const savedData = DataService.load();
                if (savedData) {
                    setBusinessInfo(savedData.businessInfo || businessInfo);
                    setSalesEntries(savedData.salesEntries || []);
                    setExpenseEntries(savedData.expenseEntries || []);
                }
            }, []);

            // Save on Change
            useEffect(() => {
                const data = {
                    businessInfo,
                    salesEntries,
                    expenseEntries,
                    lastModified: new Date().toISOString()
                };
                DataService.save(data);
            }, [businessInfo, salesEntries, expenseEntries]);


            // --- Actions ---

            const addSalesEntry = () => {
                setSalesEntries([...salesEntries, {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    invoiceNo: '',
                    customerName: '',
                    description: '',
                    quantity: 1,
                    unitPrice: 0,
                    unitCost: 0, // NEW: Cost Price
                    paymentMethod: 'Cash',
                    category: 'Goods'
                }]);
            };

            const addExpenseEntry = () => {
                setExpenseEntries([...expenseEntries, {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    category: 'Supplies',
                    vendorName: '',
                    description: '',
                    grossAmount: 0,
                    whtRate: 0,
                    paymentMethod: 'Cash',
                    deductible: 'Yes'
                }]);
            };

            const updateItem = (list, setList, id, field, value) => {
                setList(list.map(item => item.id === id ? { ...item, [field]: value } : item));
            };

            const deleteItem = (list, setList, id) => {
                if (confirm("Delete this entry?")) {
                    setList(list.filter(item => item.id !== id));
                }
            };

            const clearAllData = () => {
                if (confirm('PERMANENTLY DELETE ALL DATA? This cannot be undone.')) {
                    setSalesEntries([]);
                    setExpenseEntries([]);
                    setBusinessInfo({ ...businessInfo, name: '', rcNumber: '', tin: '' });
                    localStorage.removeItem(DB_KEY);
                }
            };

            // --- Calculations ---

            const calculateSalesMetrics = (entry) => {
                const qty = parseFloat(entry.quantity) || 0;
                const price = parseFloat(entry.unitPrice) || 0;
                const cost = parseFloat(entry.unitCost) || 0;

                const grossAmount = qty * price;
                const cogs = qty * cost; // Cost of Goods Sold
                const grossMargin = grossAmount - cogs;

                const vatAmount = grossAmount * 0.075; // 7.5% VAT
                const totalAmount = grossAmount + vatAmount;

                return { grossAmount, cogs, grossMargin, vatAmount, totalAmount };
            };

            const calculateExpenseMetrics = (entry) => {
                const gross = parseFloat(entry.grossAmount) || 0;
                const vatAmount = gross * 0.075; // 7.5% VAT paid on purchase
                const whtAmount = gross * (parseFloat(entry.whtRate || 0) / 100);
                const totalAmount = gross + vatAmount; // Assuming cost entered is exclusive of VAT
                return { grossAmount: gross, vatAmount, whtAmount, totalAmount };
            };

            // Period Helpers
            const getYear = d => new Date(d).getFullYear();
            const getMonth = d => `${getYear(d)}-${String(new Date(d).getMonth() + 1).padStart(2, '0')}`;
            const getWeek = d => {
                const date = new Date(d);
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + 4 - (date.getDay() || 7));
                const yearStart = new Date(date.getFullYear(), 0, 1);
                const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
                return `${getYear(d)}-W${weekNo}`;
            };

            const getGroupKey = (date, period) => {
                if (!date) return 'Unknown';
                if (period === 'weekly') return getWeek(date);
                if (period === 'monthly') return getMonth(date);
                return getYear(date).toString();
            };

            // Aggregation Logic
            const summaryData = useMemo(() => {
                const groups = {};

                // Process Sales
                salesEntries.forEach(entry => {
                    const key = getGroupKey(entry.date, viewPeriod);
                    if (!groups[key]) groups[key] = {
                        period: key,
                        grossRevenue: 0,
                        totalCOGS: 0,
                        grossProfit: 0,
                        vatCollected: 0,
                        operatingExpenses: 0,
                        purchVat: 0,
                        whtLiable: 0
                    };

                    const m = calculateSalesMetrics(entry);
                    groups[key].grossRevenue += m.grossAmount;
                    groups[key].totalCOGS += m.cogs;
                    groups[key].grossProfit += m.grossMargin;
                    groups[key].vatCollected += m.vatAmount;
                });

                // Process Expenses
                expenseEntries.forEach(entry => {
                    const key = getGroupKey(entry.date, viewPeriod);
                    if (!groups[key]) groups[key] = {
                        period: key,
                        grossRevenue: 0,
                        totalCOGS: 0,
                        grossProfit: 0,
                        vatCollected: 0,
                        operatingExpenses: 0,
                        purchVat: 0,
                        whtLiable: 0
                    };

                    const m = calculateExpenseMetrics(entry);
                    groups[key].operatingExpenses += m.grossAmount; // Operating Expense
                    groups[key].purchVat += m.vatAmount;
                    groups[key].whtLiable += m.whtAmount;
                });

                // Final Calculations per group
                return Object.values(groups).sort((a, b) => b.period.localeCompare(a.period)).map(g => {
                    // Net Profit = Gross Profit (Sales - COGS) - Operating Expenses
                    const netProfit = g.grossProfit - g.operatingExpenses;

                    const netVatPayable = Math.max(0, g.vatCollected - g.purchVat);
                    const cit = Math.max(0, netProfit * 0.30); // 30% CIT
                    const eduTax = Math.max(0, netProfit * 0.025); // 2.5% Edu Tax

                    return {
                        ...g,
                        netProfit,
                        netVatPayable,
                        cit,
                        eduTax,
                        totalTaxLiability: netVatPayable + cit + eduTax
                    };
                });

            }, [salesEntries, expenseEntries, viewPeriod]);


            // Export Function
            const exportToCSV = () => {
                let csv = 'Type,Date,Description,Unit Cost,Unit Price,Qty,Gross,Margin,Tax\n';
                salesEntries.forEach(s => {
                    const m = calculateSalesMetrics(s);
                    csv += `Sale,${s.date},${s.description || 'Sale'},${s.unitCost},${s.unitPrice},${s.quantity},${m.grossAmount.toFixed(2)},${m.grossMargin.toFixed(2)},${m.vatAmount.toFixed(2)}\n`;
                });
                expenseEntries.forEach(e => {
                    const m = calculateExpenseMetrics(e);
                    csv += `Expense,${e.date},${e.description || 'Expense'},-,,-,${m.grossAmount.toFixed(2)},-,${m.vatAmount.toFixed(2)}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tax_profit_data_${new Date().toISOString().slice(0, 10)}.csv`;
                a.click();
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-7xl mx-auto space-y-6">

                        {/* Header */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-900">Nigeria Tax & Profit Tracker</h1>
                                <p className="text-gray-500">Professional Edition v3.0 (COGS Enabled)</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={exportToCSV} className="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition text-sm font-medium">
                                    Export CSV
                                </button>
                                <button onClick={clearAllData} className="px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition text-sm font-medium">
                                    Reset
                                </button>
                            </div>
                        </div>

                        {/* Business Info Banner */}
                        <div className="bg-gradient-to-r from-emerald-600 to-teal-700 rounded-xl p-6 text-white shadow-lg">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <label className="text-emerald-200 text-xs uppercase tracking-wider font-semibold">Business Name</label>
                                    <input
                                        type="text"
                                        value={businessInfo.name}
                                        onChange={e => setBusinessInfo({ ...businessInfo, name: e.target.value })}
                                        className="block w-full bg-transparent border-b border-emerald-400 text-white placeholder-emerald-300 focus:outline-none focus:border-white py-1 transition"
                                        placeholder="Enter Name"
                                    />
                                </div>
                                <div>
                                    <label className="text-emerald-200 text-xs uppercase tracking-wider font-semibold">TIN</label>
                                    <input
                                        type="text"
                                        value={businessInfo.tin}
                                        onChange={e => setBusinessInfo({ ...businessInfo, tin: e.target.value })}
                                        className="block w-full bg-transparent border-b border-emerald-400 text-white placeholder-emerald-300 focus:outline-none focus:border-white py-1 transition"
                                        placeholder="Tax ID Number"
                                    />
                                </div>
                                <div className="flex items-end justify-end">
                                    <div className="text-right">
                                        <span className="block text-emerald-200 text-xs">Total Entries</span>
                                        <span className="text-2xl font-bold">{salesEntries.length + expenseEntries.length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Navigation */}
                        <div className="flex bg-white rounded-lg shadow-sm p-1">
                            <button
                                onClick={() => setActiveTab('entry')}
                                className={`flex-1 py-3 text-sm font-medium rounded-md transition ${activeTab === 'entry' ? 'bg-emerald-50 text-emerald-700' : 'text-gray-500 hover:text-gray-900'}`}
                            >
                                Data Entry
                            </button>
                            <button
                                onClick={() => setActiveTab('summary')}
                                className={`flex-1 py-3 text-sm font-medium rounded-md transition ${activeTab === 'summary' ? 'bg-emerald-50 text-emerald-700' : 'text-gray-500 hover:text-gray-900'}`}
                            >
                                Profit & Tax Reports
                            </button>
                        </div>


                        {/* --- ENTRY TAB --- */}
                        {activeTab === 'entry' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                {/* Sales Entry */}
                                <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                        <h3 className="font-bold text-gray-800">Income (Sales)</h3>
                                        <button onClick={addSalesEntry} className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
                                            + Add Sale
                                        </button>
                                    </div>
                                    <div className="p-4 max-h-[600px] overflow-y-auto space-y-4">
                                        {salesEntries.length === 0 && <p className="text-center text-gray-400 py-8 text-sm">No sales recorded.</p>}
                                        {salesEntries.map(entry => (
                                            <div key={entry.id} className="bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm space-y-2">
                                                <div className="flex gap-2">
                                                    <input type="date" value={entry.date} onChange={e => updateItem(salesEntries, setSalesEntries, entry.id, 'date', e.target.value)} className="border p-1 rounded w-32" />
                                                    <input type="text" placeholder="Description" value={entry.description} onChange={e => updateItem(salesEntries, setSalesEntries, entry.id, 'description', e.target.value)} className="border p-1 rounded flex-1" />
                                                </div>
                                                <div className="flex gap-2 items-center text-xs text-gray-500 tracking-wide uppercase font-semibold mt-2">
                                                    <div className="w-16">Qty</div>
                                                    <div className="flex-1">Unit Cost (Buy)</div>
                                                    <div className="flex-1">Unit Price (Sell)</div>
                                                    <div className="w-24 text-right">Total Sale</div>
                                                </div>
                                                <div className="flex gap-2 items-center">
                                                    <input type="number" placeholder="Qty" value={entry.quantity} onChange={e => updateItem(salesEntries, setSalesEntries, entry.id, 'quantity', e.target.value)} className="border p-1 rounded w-16" />
                                                    <input type="number" placeholder="Cost Price" value={entry.unitCost} onChange={e => updateItem(salesEntries, setSalesEntries, entry.id, 'unitCost', e.target.value)} className="border p-1 rounded flex-1 bg-red-50 text-red-600" />
                                                    <input type="number" placeholder="Sell Price" value={entry.unitPrice} onChange={e => updateItem(salesEntries, setSalesEntries, entry.id, 'unitPrice', e.target.value)} className="border p-1 rounded flex-1 bg-green-50 text-green-600" />
                                                    <div className="w-24 text-right font-bold text-gray-700">
                                                        ₦{calculateSalesMetrics(entry).grossAmount.toLocaleString()}
                                                    </div>
                                                    <button onClick={() => deleteItem(salesEntries, setSalesEntries, entry.id)} className="text-red-400 hover:text-red-600 px-2">×</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Expense Entry */}
                                <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                        <h3 className="font-bold text-gray-800">Operating Expenses</h3>
                                        <button onClick={addExpenseEntry} className="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                                            + Add Expense
                                        </button>
                                    </div>
                                    <div className="p-4 max-h-[600px] overflow-y-auto space-y-4">
                                        {expenseEntries.length === 0 && <p className="text-center text-gray-400 py-8 text-sm">No expenses recorded.</p>}
                                        {expenseEntries.map(entry => (
                                            <div key={entry.id} className="bg-gray-50 p-3 rounded-lg border border-gray-200 text-sm space-y-2">
                                                <div className="flex gap-2">
                                                    <input type="date" value={entry.date} onChange={e => updateItem(expenseEntries, setExpenseEntries, entry.id, 'date', e.target.value)} className="border p-1 rounded w-32" />
                                                    <select value={entry.category} onChange={e => updateItem(expenseEntries, setExpenseEntries, entry.id, 'category', e.target.value)} className="border p-1 rounded w-24">
                                                        <option>Supplies</option><option>Rent</option><option>Utility</option><option>Other</option>
                                                    </select>
                                                    <input type="text" placeholder="Description" value={entry.description} onChange={e => updateItem(expenseEntries, setExpenseEntries, entry.id, 'description', e.target.value)} className="border p-1 rounded flex-1" />
                                                </div>
                                                <div className="flex gap-2 items-center">
                                                    <div className="flex-1">
                                                        <input type="number" placeholder="Amount" value={entry.grossAmount} onChange={e => updateItem(expenseEntries, setExpenseEntries, entry.id, 'grossAmount', e.target.value)} className="border p-1 rounded w-full" />
                                                    </div>
                                                    <div className="flex items-center gap-1">
                                                        <span className="text-xs text-gray-500">VAT?</span>
                                                        <input type="checkbox" checked={true} readOnly title="7.5% assumed" className="accent-emerald-600" />
                                                    </div>
                                                    <button onClick={() => deleteItem(expenseEntries, setExpenseEntries, entry.id)} className="text-red-400 hover:text-red-600 px-2">×</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- SUMMARY TAB --- */}
                        {activeTab === 'summary' && (
                            <div className="space-y-6">
                                {/* Filters */}
                                <div className="flex justify-end">
                                    <div className="bg-white border rounded-lg p-1 flex text-sm">
                                        {['weekly', 'monthly', 'yearly'].map(p => (
                                            <button
                                                key={p}
                                                onClick={() => setViewPeriod(p)}
                                                className={`px-3 py-1 rounded capitalize ${viewPeriod === p ? 'bg-gray-900 text-white' : 'text-gray-600 hover:bg-gray-50'}`}
                                            >
                                                {p}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Cards Grid */}
                                {summaryData.length > 0 ? (
                                    summaryData.map(data => (
                                        <div key={data.period} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                                            <div className="bg-gray-50 px-6 py-3 border-b border-gray-100 flex justify-between items-center">
                                                <h3 className="font-bold text-lg text-gray-800">{data.period}</h3>
                                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${data.netProfit >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                    {data.netProfit >= 0 ? 'PROFITABLE' : 'LOSS'}
                                                </span>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 divide-y md:divide-y-0 md:divide-x border-gray-100">
                                                {/* Revenue + COGS */}
                                                <div className="p-6">
                                                    <div className="text-sm text-gray-500 mb-1">Gross Revenue</div>
                                                    <div className="text-2xl font-bold text-gray-900">₦{data.grossRevenue.toLocaleString()}</div>
                                                    <div className="text-xs text-red-400 mt-2 border-t pt-1">
                                                        - COGS: ₦{data.totalCOGS.toLocaleString()}
                                                    </div>
                                                </div>

                                                {/* Gross Profit + OpEx */}
                                                <div className="p-6">
                                                    <div className="text-sm text-emerald-800 font-semibold mb-1">Gross Profit</div>
                                                    <div className="text-2xl font-bold text-emerald-600">₦{data.grossProfit.toLocaleString()}</div>
                                                    <div className="text-xs text-red-400 mt-2 border-t pt-1">
                                                        - Op. Expenses: ₦{data.operatingExpenses.toLocaleString()}
                                                    </div>
                                                </div>

                                                {/* Net Profit */}
                                                <div className="p-6 bg-emerald-50/50">
                                                    <div className="text-sm text-emerald-900 mb-1 font-bold uppercase tracking-wider">Net Profit</div>
                                                    <div className={`text-3xl font-bold ${data.netProfit >= 0 ? 'text-emerald-700' : 'text-red-500'}`}>
                                                        ₦{data.netProfit.toLocaleString()}
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">Gross Profit - OpEx</div>
                                                </div>

                                                {/* Tax Liability */}
                                                <div className="p-6 bg-gray-50/50">
                                                    <div className="text-sm text-gray-600 mb-1 font-semibold">Est. Tax Liability</div>
                                                    <div className="text-2xl font-bold text-gray-800">
                                                        ₦{data.totalTaxLiability.toLocaleString()}
                                                    </div>
                                                    <div className="space-y-1 mt-2">
                                                        <div className="flex justify-between text-xs text-gray-500">
                                                            <span>Net VAT:</span>
                                                            <span>{data.netVatPayable.toLocaleString()}</span>
                                                        </div>
                                                        <div className="flex justify-between text-xs text-gray-500">
                                                            <span>CIT (30%):</span>
                                                            <span>{data.cit.toLocaleString()}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                                        <p className="text-gray-500">No data available for this view.</p>
                                    </div>
                                )}
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TaxComplianceTracker />);
    </script>
</body>

</html>
